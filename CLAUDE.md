# .NET API Agent 工作流程

## 📌 总体概述

根据用户需求自动生成 API 设计文档和代码，进行 .NET 10 微服务架构的后端 API 开发工作。

## 🔴 核心原则

### 文档驱动开发（Document-Driven Development）

1. **plan.md 是项目级总体规划文档**

   - 项目根目录 `projects/项目名/plan.md`：项目级开发计划，包含服务划分、开发顺序、里程碑等
   - 所有开发工作必须按照 plan.md 的规划进行
   - 需求变更时必须同步更新 plan.md
2. **spec.md 是服务级功能说明书**

   - 各服务根目录 `projects/项目名/{ServiceName}/spec.md`：服务级完整功能说明书，使用 `rules/service-spec-template.md` 模板
   - spec.md 中应包含每个 Controller 的功能描述
   - 严禁代码与文档不一致
3. **开发必须按顺序进行**

   - 需求分析 → 生成 plan.md → 生成各服务根目录 spec.md → 再进行开发 → 代码变更时同步更新文档
   - 严禁跳过 plan.md 或 spec.md 直接编写代码
4. **需求变更管理**

   - 任何新增/调整需求必须先更新 plan.md，再更新对应服务的根目录 spec.md（`projects/项目名/{ServiceName}/spec.md`）
   - 严禁在不更新文档的情况下直接开发新功能
5. **代码与文档双向一致性**

   - 若发现代码实现与 spec.md 不一致，应主动指出并要求基于代码实现更新对应的 spec.md
   - 确保文档始终反映真实的系统状态

### 技术规范遵循

**在开始任何工作前必须完整阅读 `skills/` 目录下的技能文档！**

1. **dotnet-architect** ⭐⭐⭐ - .NET 架构设计和代码审查（需求分析、技术选型、架构决策）
2. **net-microservice-generator** ⭐⭐⭐ - .NET 微服务项目架构和生成规范（项目框架生成）
3. **net-api-developer** ⭐⭐⭐ - .NET API 开发规范（Controller、DTO、服务注册等）
4. **net-efcore-developer** ⭐⭐⭐ - EF Core 数据库开发规范（实体模型、Fluent API、数据库迁移等）
5. **net-cache-use** ⭐⭐ - 缓存类库创建与使用规范（为业务实体添加缓存功能）
6. **net-database-bulkcopy** ⭐⭐ - PostgreSQL 批量数据操作规范（大数据量导入/更新/同步场景）
7. **net-background-job** ⭐⭐ - 后台循环任务开发规范（定时任务、数据同步等场景）

---

## 🔄 工作流程总览

```
用户输入需求 → 需求分析与澄清 → 项目规划（生成 plan.md） → 各服务根目录 spec.md（projects/项目名/{ServiceName}/spec.md） → 项目框架生成 → 详细功能开发 → 服务验证 → 交付
```

---

## 📄 阶段零：需求分析与澄清

**核心原则**：主动沟通，充分理解，避免误解

### 📂 前端规格说明书优先模式

**⚠️ 重要条件**：若当前目录存在 `projects/web_specs/spec.md` 以及 `projects/web_specs/specs/` 文件夹，则启动**前端规格说明书驱动模式**：

| 文件/目录                         | 说明                           | 用途                                   |
| --------------------------------- | ------------------------------ | -------------------------------------- |
| `projects/web_specs/spec.md`    | 项目前端开发的需求规格说明书   | 整体功能需求、技术栈、接口规范         |
| `projects/web_specs/specs/*.md` | 前端各个页面的页面级规格说明书 | 各页面功能细节、API 调用需求、数据结构 |

**工作流程**：

```
读取 projects/web_specs/spec.md → 读取 projects/web_specs/specs/*.md → 分析前端 API 需求 → 生成后端 API 项目
```

**关键要点**：

1. **需求分析依据**：以 `projects/web_specs/spec.md` 和 `projects/web_specs/specs/*.md` 为主要需求来源
2. **API 接口推导**：从前端页面的 API 调用需求反向推导后端接口设计
3. **数据结构对齐**：确保后端返回的数据结构与前端页面规格要求一致
4. **服务拆分决策**：根据前端功能模块划分后端微服务边界
5. **spec.md 生成**：基于前端规格说明书生成对应服务的 `projects/项目名/{ServiceName}/spec.md`

### 需求确认

使用 `AskUserQuestion` 工具确认基础要素和架构要素（若一次交互无法确认全部需求，可进行多次交互）：

#### 基础要素

| 要素     | 说明             | 示例                                          |
| -------- | ---------------- | --------------------------------------------- |
| 服务名称 | 服务唯一标识     | 用户服务、订单服务、支付服务                  |
| 核心目标 | 解决什么问题     | 提供用户认证和授权功能                        |
| 业务领域 | 所属业务模块     | 用户管理、订单处理、支付结算                  |
| 功能清单 | 包含哪些功能模块 | 用户注册、登录、信息管理、权限控制            |
| 数据实体 | 需要哪些数据表   | 用户表、角色表、权限表                        |
| 接口需求 | 需要哪些 API     | POST /api/users/register、GET /api/users/{id} |
| 认证方式 | API 认证方式     | Bearer Token、Basic Auth、无需认证            |

#### 架构要素（重点）

**⚠️ 重要**：微服务架构设计直接影响系统可扩展性和维护性，必须重点确认以下架构要素：

| 架构要素           | 说明                     | 示例                           |
| ------------------ | ------------------------ | ------------------------------ |
| **服务拆分** | 如何拆分微服务           | 按业务领域（用户、订单、支付） |
| **数据隔离** | 数据库归属策略           | 每个服务独立数据库             |
| **通信方式** | 服务间通信方式           | HTTP REST API（暂不考虑 MQ）   |
| **认证服务** | 是否需要 IdentityService | 统一认证授权服务               |
| **通用组件** | 需要哪些通用类库         | Common、Cache、工具类          |
| **技术约束** | 技术限制和规范要求       | .NET 10、PostgreSQL、EF Core   |

**💡 提示**：

- 如果用户不清楚服务拆分方式，可提供 2-3 种拆分方案供选择
- 数据隔离策略应考虑业务边界和数据一致性要求
- 认证服务通常作为独立服务统一管理用户身份

### ⚠️ 常见误区

- ❌ 直接基于模糊需求开始开发
- ❌ 假设用户没有提到的功能就是不需要
- ❌ 仅凭猜测做出技术决策
- ❌ 忽视微服务拆分的合理性
- ✅ 主动提问澄清所有不确定点
- ✅ 确认边界条件和特殊情况
- ✅ 与用户确认对需求的理解是否准确
- ✅ 评估服务拆分的必要性

---

## 📝 阶段零点五：项目规划

**前置条件**：需求分析与澄清完成，已确认基础要素和架构要素

**核心原则**：先规划后开发，确保开发工作有序进行

### 核心任务

生成项目级总体规划文档 `plan.md`，存放在项目根目录 `projects/项目名/plan.md`。

### plan.md 文档结构

| 章节                 | 内容说明                           |
| -------------------- | ---------------------------------- |
| **项目概述**   | 项目名称、核心目标、业务领域       |
| **服务规划**   | 微服务拆分方案、各服务职责边界     |
| **开发顺序**   | 服务开发优先级排序、依赖关系说明   |
| **里程碑计划** | 各阶段目标、关键节点、预期交付物   |
| **技术架构**   | 技术选型、数据库规划、通用组件规划 |
| **风险识别**   | 潜在技术风险、业务风险及应对策略   |

### 规划要点

1. **服务拆分决策**

   - 根据业务领域确定微服务边界
   - 明确各服务的职责和接口边界
   - 评估服务间依赖关系
2. **开发优先级排序**

   - 基础服务优先（如认证服务、通用组件）
   - 核心业务服务其次
   - 辅助服务最后
3. **里程碑划分**

   - 每个里程碑包含明确的服务交付目标
   - 标注各里程碑的前置依赖
   - 预留集成测试和调整时间

### 规划确认

plan.md 生成后，需与用户确认以下内容：

- 服务拆分是否合理
- 开发顺序是否符合业务优先级
- 里程碑划分是否可接受

**⚠️ 确认后**：plan.md 成为项目开发的指导性文档，后续开发严格按照规划进行。

### 计划变更管理

**适用场景**：需求变更、技术调整、优先级变化

**变更流程**：

```
发现变更需求 → 评估对 plan.md 的影响 → 更新 plan.md → 更新相关 spec.md → 获得确认 → 继续开发
```

**变更规范**：

1. 任何影响服务拆分、开发顺序、里程碑的变更必须先更新 plan.md
2. 更新 plan.md 后，同步更新受影响服务的 spec.md
3. 严禁在不更新 plan.md 的情况下调整开发计划

---

## 阶段一：生成完整服务功能说明书

**前置条件**：需求分析与澄清完成，项目规划（plan.md）已完成并确认

### 核心任务

按照 `rules/service-spec-template.md` 模板，基于 plan.md 中的服务规划，生成服务级 spec.md：

**文件路径**：`projects/项目名/{ServiceName}/spec.md`

### 技术栈规范（不可变）

⚠️ **严格遵循**：必须使用以下技术栈，详细规范见各技能文档：

**核心框架**：

- **.NET 版本**：10
- **数据库**：PostgreSQL
- **ORM**：Entity Framework Core（Code First）
- **架构模式**：微服务架构

**项目模板**：

- **Web API 服务**：使用 `ThirdNet.Core.WebApiService` 模板
- **认证服务**：使用 `ThirdNet.Core.IdentityService` 模板
- **类库项目**：使用标准 `classlib` 模板

### 服务结构规范

项目以 projects 作为根目录。

**详细目录结构**：请参考 `skills/net-microservice-generator/SKILL.md` 的"标准目录结构"章节。

**核心要点**：

- `Tools/` 目录存放通用工具类库（`{项目名}.Common`、`{项目名}.Cache`）
- 每个服务包含 Api 和 Database 两个项目
- 使用公司模板 `ThirdNet.Core.WebApiService` 或 `ThirdNet.Core.IdentityService`
- 服务根目录必须包含 `spec.md`（服务级完整功能说明书）

**命名规范**：

- 所有目录使用 Pascal 命名（首字母大写）：`Controllers/`、`Manager/`、`App/`、`Third/`
- Controllers 子目录按调用方分类：
  - `Manager/`：管理端（后台管理、运营管理等场景）
  - `App/`：应用端（移动应用、Web 应用等用户端场景）
  - `Third/`：第三方端（开放 API、合作伙伴集成等场景）

### 需求变更管理（持续性流程）

**适用场景**：服务开发过程中所有新增需求、功能调整、需求变更

### 变更流程

```
发现新需求 → 评估影响 → 更新对应服务的根目录 spec.md（projects/项目名/{ServiceName}/spec.md） → 获得确认 → 继续开发
```

### 变更规范

1. **第一时间更新对应服务的根目录 spec.md**

   - 新增 API → 补充到"API 接口清单"和"接口设计规范"
   - 调整功能 → 更新对应的"业务流程"和"数据结构"
   - 变更实体 → 更新"数据库设计"和"数据模型"
2. **变更影响评估**

   - 评估对现有 API 的影响
   - 评估是否需要调整数据库结构
   - 评估是否需要调整其他服务
3. **确认后再开发**

   - 对应服务的根目录 spec.md 更新完成后需获得确认
   - 确认后方可进行代码开发

---

## 🏗️ 阶段二：项目框架生成

**前置条件**：plan.md 已确认，对应服务的 spec.md（`projects/项目名/{ServiceName}/spec.md`）已完成

### 项目生成范围

**目标**：按照 plan.md 中规划的开发顺序，使用 `net-microservice-generator` 技能生成标准化的微服务项目结构

### 框架验证内容

1. 项目结构是否符合标准规范
2. 各服务项目能否正常编译
3. 数据库连接配置是否正确

**⚠️ 验证通过后**：进入阶段三，基于对应服务的根目录 spec.md 进行详细功能开发。

## 📋 阶段三：详细功能开发

**前置条件**：

1. 对应服务的 spec.md（`projects/项目名/{ServiceName}/spec.md`）已完成
2. 项目框架已生成并验证通过
3. 基础架构已确认

### 开发规范

1. 所有开发工作必须基于服务根目录 spec.md 中的设计和功能描述
2. 新增或调整功能时，必须先更新对应服务的根目录 spec.md
3. Controller 的功能描述必须在服务根目录 spec.md 中维护和更新

### 开发流程

```
创建实体模型 → 创建 Fluent API 配置 → 创建 Controller → 实现 API 接口 → 注册配置 → 测试验证
```

---

## ✅ 阶段四：完整服务验证

### 验证内容

1. 项目可编译且正常启动
2. API 接口功能完整验证
3. 数据库操作正确性验证
4. Swagger 文档完整性验证
5. 整体服务的集成验证

### 验证流程

```
编译项目 → 启动服务 → Swagger 文档检查 → API 接口测试 → 数据库验证 → 验证通过
```

### 说明

- 使用 Swagger UI 进行 API 接口测试
- 确保所有接口正常返回预期结果
- 验证数据库操作（增删改查）的正确性
- 验证认证授权机制是否生效
- 确保代码与需求文档一致
- 确保没有占位代码或未实现的功能

---

## 📋 工作流程总结

```
1️⃣ 需求分析与澄清
   ↓
2️⃣ 项目规划（生成 plan.md）
   ↓
3️⃣ 生成各服务根目录 spec.md（projects/项目名/{ServiceName}/spec.md）（服务级完整功能说明书）
   ↓
4️⃣ 项目框架生成（使用 net-microservice-generator）
   ↓
5️⃣ 详细功能开发（遵循 net-api-developer 和 net-efcore-developer）
   ↓
6️⃣ 完整服务验证
   ↓
7️⃣ 交付成果
```

**核心原则回顾**：

- plan.md（`projects/项目名/plan.md`）是项目级开发计划文档
- 各服务 spec.md（`projects/项目名/{ServiceName}/spec.md`）是服务级功能说明书
- 所有开发工作必须基于 plan.md 规划和服务 spec.md
- 需求变更必须先更新 plan.md，再更新对应服务 spec.md
- 代码与文档保持一致
- 严格遵循 .NET 微服务开发规范
